---
title: "Covid-19 and Social Capital"
author: "Hyeonjin Cha"
date: "3/17/2021"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rio)
library(here)
library(janitor)
library(usmap)
library(ggpubr)
library(reactable)
library(magrittr)
```


```{r load data}
covid <- import(here("data", "covid-data-01-30-2021.csv")) %>% 
  clean_names() %>% 
  as_tibble() #load covid data

soccap <- import(here("data", "social-capital-project-state-index.xlsx")) %>% 
  clean_names() %>%
  as_tibble() #load state level social capital data 

soccap_covid <- soccap %>% 
  left_join(covid, by = c("state" = "province_state"))

soccap_county <- import(here("data", "social-capital-project-county-index.xlsx")) %>% 
  clean_names() %>% 
  as_tibble() %>% 
  rename(fips = fips_code) #load county level social capital data 

```


Raw Data {data-icon="fa-table"}
======================================================================

What is this? {.sidebar}
----------------------------------------------------------------------

**Data Source**

The visualizations utilize data from two different sources:

1) State-Level Social Capital Index: [Social Capital Project by the United States Congress Joint Economic Committee](https://www.worldvaluessurvey.org/WVSNewsShowMore.jsp?evYEAR=2020&evMONTH=-1)

2) State-Level Covid-19 Statistics: [COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University](https://github.com/CSSEGISandData/COVID-19)

**Key Variables**

**Visualization #1**

Covid-19 testing, cases, and deaths by each state.

**Visualization #2**

Mapping state-level social Capital index.

**Visualization #3**

Regressions examining the relationship between social capital index and Covid-19 metrics.


Column {.tabset}
-----------------------------------------------------------------------
### Raw Data
```{r}
soccap_covid_clean <- soccap_covid %>% 
  select(state, fips_code, 
         state_level_index, 
         family_unity, family_interaction, social_support, community_health, institutional_health, collective_efficacy, philanthropic_health,
         total_test_results,
         confirmed,
         deaths
         )
reactable(soccap_covid_clean)
```

Visualization #1: Covid-19 {data-icon="fa-signal"}
===================================== 
Description {.sidebar}
----------------------------------------------------------------------

**Visualization #1**


Column {.tabset}
-----------------------------------------------------------------------

### Initial Draft

```{r}
#Plot part 1. Covid cases, deaths, and testing by state
data_plota <- soccap_covid_clean %>%
  select(state, confirmed, deaths, total_test_results)


state_covid_altogether <- data_plota %>%
  mutate(state = fct_reorder(state, total_test_results))  %>% 
  pivot_longer(!state, names_to = "type", values_to = "count") %>%
  ggplot(aes(state, count/1000, fill = type)) +
  geom_col(position = "dodge2") + 
  scale_fill_brewer(palette = "Dark2") + 
  coord_flip() + 
  theme_minimal()
state_covid_altogether

```

### Revised Plot

```{r}
#Plot part 1. Covid cases, deaths, and testing by state

state_covid_test <- data_plota %>%
  mutate(state = fct_reorder(state, total_test_results))  %>% 
  ggplot(aes(state, total_test_results/1000)) +
  geom_col(fill = "deepskyblue3", alpha = 0.7) + 
  coord_flip() +
  labs(x = "State", subtitle = "Tests", y="") + 
  theme_minimal()

state_covid_case <- data_plota %>%
  mutate(state = fct_reorder(state, confirmed))  %>% 
  ggplot(aes(state, confirmed/1000)) +
  geom_col(fill = "darkorange", alpha = 0.7) + 
  coord_flip() +
  labs(x = " ", subtitle = "Cases", y = "Counts by 1000") + 
  theme_minimal()

state_covid_death <- data_plota %>%
  mutate(state = fct_reorder(state, deaths))  %>% 
  ggplot(aes(state, deaths/1000)) +
  geom_col(fill = "brown1", alpha = 0.7) + 
  coord_flip() + 
  labs(x = " ", subtitle = "Deaths", y = "") + 
  theme_minimal()

covid_plots <- ggarrange(state_covid_test,
                         state_covid_case,
                         state_covid_death,
                         ncol = 3,
                         nrow = 1)
covid_plots

```

### Final Plot
```{r}
#Plot part 1. Covid cases, deaths, and testing by state
data_plota <- soccap_covid_clean %>%
  select(state, confirmed, deaths, total_test_results)

state_covid_test <- data_plota %>%
  mutate(state = fct_reorder(state, total_test_results))  %>% 
  ggplot(aes(state, total_test_results/1000)) +
  geom_col(fill = "deepskyblue3", alpha = 0.7) + 
  coord_flip() +
  labs(x = "State", subtitle = "Tests", y="") + 
  theme_minimal()

state_covid_case <- data_plota %>%
  mutate(state = fct_reorder(state, confirmed))  %>% 
  ggplot(aes(state, confirmed/1000)) +
  geom_col(fill = "darkorange", alpha = 0.7) + 
  coord_flip() +
  labs(x = " ", subtitle = "Cases", y = "Counts by 1000") + 
  theme_minimal()

state_covid_death <- data_plota %>%
  mutate(state = fct_reorder(state, deaths))  %>% 
  ggplot(aes(state, deaths/1000)) +
  geom_col(fill = "brown1", alpha = 0.7) + 
  coord_flip() + 
  labs(x = " ", subtitle = "Deaths", y = "") + 
  theme_minimal()

covid_plots <- ggarrange(state_covid_test,
                         state_covid_case,
                         state_covid_death,
                         ncol = 3,
                         nrow = 1)
covid_plots

```



Visualization #2: Social Capital Index {data-icon="fa-signal"}
===================================== 
Description {.sidebar}
----------------------------------------------------------------------

**Visualization #2**


Column {.tabset}
-----------------------------------------------------------------------
### State Level Index
    
```{r}
plot_usmap(data = soccap_covid_clean, regions = "states", values = "state_level_index", labels = TRUE) +
  scale_fill_continuous(low = "white", 
                        high = "steelblue1") + 
  theme(panel.background = element_rect(color = "black", fill = "white")) + 
  theme(legend.position = "none") + 
  scale_fill_distiller(palette = "RdBu", direction = -1) +
  theme(legend.position = c(1, 3), plot.title = element_text(hjust=1)) +
  labs(title = "State-Level Overall Social Capital Index",
       subtitle = "Thicker color indicates higher levels of social capital index")

```
    
### County Level Index in Oregon

```{r}
plot_usmap(data = soccap_county, include = c("OR"), 
           regions = "counties", values = "county_level_index", labels = TRUE) +
  scale_fill_continuous(low = "white", 
                        high = "steelblue1") + 
  theme(panel.background = element_rect(color = "black", fill = "white")) + 
  theme(legend.position = "none") + 
  labs(title = "County-Level Overall Social Capital Index in Oregon",
       subtitle = "Thicker color indicates higher levels of social capital index")

```


Visualization #3: Regressions {data-icon="fa-signal"}
===================================== 
Description {.sidebar}
----------------------------------------------------------------------
**Visualization #3**

Column {.tabset}
----------------------------------------------------------------------

#Draft Regression Model

```{r}
soccap_covid_clean %<>%
  mutate(positivity = confirmed / total_test_results, fatality = deaths / confirmed) 

soccap_covid_clean %>% 
  ggplot(aes(state_level_index, positivity)) + 
  geom_point() + 
  geom_smooth(method = "lm", color = "black", se = FALSE) + 
  labs(title = "Relationship between Social Capital and Covid-19 Positivity",
       x = "State Level Social Capital Index",
       y = "Posivitity Rate (%)") + 
  theme(panel.background = element_rect(color = "black", fill = "white")) 
```

```{r}
model1a <- lm(positivity ~ state_level_index, data = soccap_covid_clean)
summary(model1a)
```

```{r}
model2a <- lm(fatality ~ state_level_index, data = soccap_covid_clean)
model2b <- lm(fatality ~ family_unity + family_interaction + social_support + community_health + institutional_health + collective_efficacy + philanthropic_health, data = soccap_covid_clean)

soccap_covid_clean %>% 
  ggplot(aes(state_level_index, fatality)) + 
  geom_point() + 
  geom_smooth(method = "lm", color = "black", se = FALSE) + 
  labs(title = "Relationship between Social Capital and Covid-19 Fatality",
       x = "State Level Social Capital Index",
       y = "Fatality Rate (%)") + 
  theme(panel.background = element_rect(color = "black", fill = "white")) 
```

```{r}
model2a <- lm(fatality ~ state_level_index, data = soccap_covid_clean)
summary(model2a)
```
